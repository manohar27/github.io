{"componentChunkName":"component---src-templates-blog-post-js","path":"/content-length/","webpackCompilationHash":"a5786bc0ee3172a3c89d","result":{"data":{"site":{"siteMetadata":{"title":"lateralus","author":"Manohar Srinivasa"}},"markdownRemark":{"id":"1fe1a374-e2cc-5ee1-8fa3-3530bb827776","excerpt":"TLDR; The fix is therefore to use Buffer.from(string).length to set  instead of string.length. What’s Content-Length? It’s an HTTP header both the client and…","html":"<p><em>TLDR; The fix is therefore to use Buffer.from(string).length to set <code class=\"language-text\">Content-Length</code> instead of string.length.</em></p>\n<h2>What’s Content-Length?</h2>\n<p>It’s an HTTP header both the client and the server use to denote the size of the request/response body.</p>\n<h2>Story time</h2>\n<ul>\n<li>Was working with a POST API endpoint that expected some text in the request body. </li>\n<li>The code was already in place and we faced issues where some requests were failing and we couldn’t reproduce it in other environments.\n(<em>Mistake: Didn’t use the exact same text to reproduce in other env</em>)</li>\n</ul>\n<p><img src=\"https://i.imgur.com/J5nr5LQ.jpg?fb\"></p>\n<p>After spending hours and days debugging this issue, we found out that the API was returning a JSON parse error. </p>\n<p>The request body that looked something like this</p>\n<p><code class=\"language-text\">{\n  &quot;text&quot;: &quot;Madam I’m Adam&quot;\n}</code></p>\n<p>Simple json, JSON parse error? Whaat? </p>\n<p>The culprit : <code class=\"language-text\">Content-Length</code>. </p>\n<p>The call looked something like this</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">fetch(url, {\n  headers: {\n    &#39;Content-Type&#39;: &#39;application/json&#39;,\n    &#39;Content-Length`: requestBody.length\n  },\n  body: requestBody\n})</code></pre></div>\n<h2>The Issue</h2>\n<p> When there’s a non ascii, multi-byte character, such as this apostrophe for example <code class=\"language-text\">’</code>, which is different from the regular <code class=\"language-text\">&#39;</code>, string.length can’t be used to calculate <code class=\"language-text\">Content-Length</code>.</p>\n<p> While string.length gives the size of the string, it is only the character count. It’s not the actual size the string takes up in bytes/octets.</p>\n<p> MDN <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Length\">says <code class=\"language-text\">Content-Length</code></a> is <code class=\"language-text\">The length in decimal number of octets.</code></p>\n<p>See the difference here. We can use Buffer.from(string).length to get the actual size of the string</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 288px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3bf044ab27087a5a7cb12cfe8bcefbfd/337b6/non-ascii-char-lengths.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.041666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABZklEQVQoz31S2W7CQBDLTyAICQlJy5L7PoEE8RX8/5e465EWVW3pw2hmj/HY3rX8MESQKpzKCKpOkPUl2rZFFEU4HA7wPO9XcP/dmZXnH4ijAI7tIlJn3C5XPB4PnM9n7Pd7uK4Lx3Gktm1bsgH7C9RSykNVx+j6AU3bQCmFOI6FZZ7nUidJgrIs0fc96rr+n2GcBJimAl3XSxNB0jTFsiwCToYEbZpG9njnHTsBjKKjbgg14IB5nlAUhQDSw67rcLlcpOYgsjaA70J7GGKaPX2ZDFZhQv8IOgwcMiMIApG6rqsA0svdbifsjbcMstYe+rjfM4zjIE2UR5bjOL4ypZIhveSg2+0mwbqqKm3ZJEpC/WOsoiDgpz5oBNA8BJllWSYsjXdmGAEY9Jj3r9erPBiVWCfl4vm8a6ktNpuNfBEGJTFTyna7FWnm+/Dsu2TWL8med9TTFqHOBt/3xVyTf9Zm/XPPxBf6BiLCcnfdEwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image\"\n        title=\"image\"\n        src=\"/static/3bf044ab27087a5a7cb12cfe8bcefbfd/337b6/non-ascii-char-lengths.png\"\n        srcset=\"/static/3bf044ab27087a5a7cb12cfe8bcefbfd/cf440/non-ascii-char-lengths.png 148w,\n/static/3bf044ab27087a5a7cb12cfe8bcefbfd/337b6/non-ascii-char-lengths.png 288w\"\n        sizes=\"(max-width: 288px) 100vw, 288px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>So string.length gives a lower value than the actual size of the request body. API looks at the lower Content-Length chops off the last few bytes, what that means is the request might end up lookin like this</p>\n<p><code class=\"language-text\">{\n  &quot;text&quot;: &quot;Madam I’m Adam&quot;</code></p>\n<p>Notice the missing <code class=\"language-text\">}</code>. This causes the JSON parse error. </p>\n<p>The fix is therefore to use Buffer.from(string).length to set <code class=\"language-text\">Content-Length</code>.</p>\n<p><em>FYI: GET with Request Body requires us to send Content-Length header explicitly, whereas for PUT &#x26; POST you can choose to not send it.</em></p>","frontmatter":{"title":"The Content-Length story","date":"July 08, 2021","description":"Javascript's string.length vs Buffer.from(string).length, understanding how to set Content-Length header"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/content-length/","previous":{"fields":{"slug":"/heptagram-svg/"},"frontmatter":{"title":"How to make a Heptagram with SVG ?"}},"next":null}}}