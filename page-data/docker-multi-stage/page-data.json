{"componentChunkName":"component---src-templates-blog-post-js","path":"/docker-multi-stage/","webpackCompilationHash":"dca5d3d7fd2dc3e97817","result":{"data":{"site":{"siteMetadata":{"title":"Manohar's Blog","author":"Manohar Srinivasa"}},"markdownRemark":{"id":"5477e648-c0d8-51a1-a6c8-1125f4f1061d","excerpt":"So you use docker and you’ve written a Dockerfile that looks neat and everything looks and runs great. But if you look at your docker image sizes, it might be…","html":"<p>So you use docker and you’ve written a Dockerfile that looks neat and everything looks and runs great. But if you look at your docker image sizes, it might be huge. It was in my case at work, and it kind of defeated the purpose of using containers.</p>\n<p>Here’s something you can do quickly to drop some serious bytes from your Docker Image size. </p>\n<p>Change your Dockerfile from something like this</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM node:8.16\nRUN npm install\nRUN npm run build #lets say this generates your build bundles (dist folder)\nCMD [&quot;npm&quot;, &quot;run&quot;, &quot;start&quot;]</code></pre></div>\n<p>To something like this</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM node:8.16 as builder\nRUN npm install\nRUN npm run build\n\nFROM node:8.16 as production\nCOPY --from=builder /dist ./\n#COPY more stuff from builder like your ./server/node_modules and ./server/ whatever you need from your builder image\nCMD [&quot;npm&quot;, &quot;run&quot;, &quot;start&quot;]</code></pre></div>\n<p>Okay so here’s what you did with this “multi-stage” build.</p>\n<ul>\n<li>You created an intermediate image (<strong>builder)</strong></li>\n<li>You use the <strong>builder</strong> to install stuff you need ( this could even include a lot of stuff you don’t need in production like acceptance testing tools etc)</li>\n<li>But when you want the <strong>production</strong> image, you pick and choose what parts of <strong>builder</strong> you need, for e.g here I’m just copying the dist folder.</li>\n<li><strong>production</strong> image starts FROM node:8.16, it just adds one more layer on top to copy the dist folder</li>\n</ul>\n<p>But how did this help? Every docker instruction adds a bunch of size to your image. Every RUN, ADD, COPY adds to your image size. If you have fewer instructions, then you can reduce your image size. Using multi-stage build is a clean way to achieve fewer instructions.</p>\n<p>You can go through <a href=\"https://docs.docker.com/develop/develop-images/dockerfile_best-practices/\">this link</a> to find some cool best practice tips to write Dockerfiles.</p>","frontmatter":{"title":"How to leverage multi-stage docker build to trim down the image size?","date":"September 23, 2019","description":"Use multi-stage builds to trim down your docker image size, here I explain with a node application"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/docker-multi-stage/","previous":null,"next":null}}}